<!DOCTYPE html>
<html lang="ht">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Istorik Tranzaksyon — Echanj Plus</title>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<style>
  :root{
    --bg:#0a1f44;
    --card: rgba(255,255,255,0.06);
    --accent:#0056b3;
    --gold:#FFD700;
    --text:#ffffff;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Arial, Helvetica, sans-serif;
    background:var(--bg);
    color:var(--text);
    min-height:100vh;
    padding:28px;
    display:flex;
    justify-content:center;
  }
  .wrap{
    width:100%;
    max-width:820px;
  }
  header{text-align:center;margin-bottom:18px}
  .logo{width:140px;display:block;margin:0 auto 8px}
  h1{margin:0;font-style:italic;color:var(--gold)}
  .subtitle{font-size:13px;opacity:.9;margin-top:6px}

  .controls{
    display:flex;
    gap:10px;
    margin:18px 0;
    align-items:center;
  }
  .controls input{
    flex:1;
    padding:10px 12px;
    border-radius:10px;
    border:1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.03);
    color:var(--text);
    outline:none;
  }
  .controls button{
    padding:10px 14px;
    border-radius:10px;
    border:none;
    background:var(--accent);
    color:white;
    cursor:pointer;
    font-weight:700;
  }
  .controls button.secondary{
    background:transparent;
    border:1px solid rgba(255,255,255,0.12);
    color:var(--text);
  }

  .info{
    margin-bottom:12px;
    font-size:13px;
    color:#e8e8e8;
  }

  .transactions{
    display:grid;
    gap:14px;
  }

  .card{
    background:var(--card);
    padding:14px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,0.08);
    box-shadow:0 8px 24px rgba(0,0,0,0.35);
  }
  .card .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .card .top .type{font-weight:700;color:#fff}
  .card p{margin:6px 0;color:#e6eef9;font-size:14px}
  .empty{ text-align:center;color:#f0f0f0;opacity:.8;margin-top:18px }

  .loader{ display:inline-block;padding:8px 12px;background:rgba(255,255,255,0.06);border-radius:8px }

  .note{ font-size:13px;color:#dcdcdc;margin-top:10px;opacity:.9 }

  .back{
    display:inline-block;margin-top:16px;padding:10px 14px;border-radius:8px;background:var(--accent);color:#fff;text-decoration:none;
  }
  .err{ color:#ffb4b4;margin-top:10px }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <img class="logo" src="https://i.postimg.cc/L8VgxQq9/image1-removebg-preview.png" alt="Echanj Plus logo">
      <h1>Istorik Tranzaksyon</h1>
      <div class="subtitle">Mete UID ou oswa pase li nan URL (?uid=ARS-xxxx) pou wè tranzaksyon ou yo</div>
    </header>

    <div class="controls">
      <input id="uidInput" placeholder="Antre UID pèsonèl ARS-XXXX oswa kite vid pou itilize uid nan URL" />
      <button id="loadBtn">Chaje</button>
      <button id="clearBtn" class="secondary">Efase</button>
    </div>

    <div class="info" id="info">Pa gen anyen chaje ankò.</div>
    <div id="errMsg" class="err" style="display:none"></div>

    <div id="transactions" class="transactions"></div>
    <div id="empty" class="empty" style="display:none">Pa gen tranzaksyon pou UID sa a.</div>

    <a class="back" href="home.html">← Retounen sou Home</a>
  </div>

<script>
  // ----- Firebase config (ranplase si bezwen) -----
  const firebaseConfig = {
    apiKey: "AIzaSyB1VTPakleoggsbLdpm_HS7nSb3A7A99Qw",
    authDomain: "echanj-plus-778cd.firebaseapp.com",
    databaseURL: "https://echanj-plus-778cd-default-rtdb.firebaseio.com",
    projectId: "echanj-plus-778cd",
    storageBucket: "echanj-plus-778cd.appspot.com",
    messagingSenderId: "111144762929",
    appId: "1:111144762929:web:e64ce9a6da65781c289f10",
    measurementId: "G-J1BQRF32ZW"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ----- UI refs -----
  const uidInput = document.getElementById('uidInput');
  const loadBtn = document.getElementById('loadBtn');
  const clearBtn = document.getElementById('clearBtn');
  const info = document.getElementById('info');
  const errMsg = document.getElementById('errMsg');
  const transactionsEl = document.getElementById('transactions');
  const emptyEl = document.getElementById('empty');

  // ----- helper -----
  function showError(text){
    errMsg.style.display = text ? 'block' : 'none';
    errMsg.textContent = text || '';
  }
  function setInfo(text){ info.textContent = text || ''; }
  function clearList(){ transactionsEl.innerHTML = ''; emptyEl.style.display='none'; }

  // ----- read uid from URL if present -----
  const urlParams = new URLSearchParams(window.location.search);
  const uidFromUrl = urlParams.get('uid'); // ARS-xxxx if present
  if(uidFromUrl){
    uidInput.value = uidFromUrl;
    setInfo("UID chaje depi URL la: " + uidFromUrl);
  } else {
    setInfo("Antre UID (ARS-XXXX) epi klike Chaje, osinon fè k ap soti nan Home pase ?uid=...");
  }

  // ----- main load function -----
  let currentListener = null; // pou detach si bezwen

  async function loadTransactionsForCustomUID(customUID){
    showError('');
    clearList();
    setInfo("Ap tcheke UID `" + customUID + "` ...");
    // jwenn firebaseUid depi index/customUID/{ARS-XXXX}
    try{
      const snap = await db.ref('index/customUID/' + customUID).get();
      if(!snap.exists()){
        setInfo('');
        emptyEl.style.display = 'none';
        showError("UID pa jwenn nan sistèm nan. Verifye li e eseye ankò.");
        return;
      }
      const firebaseUid = snap.val();
      setInfo("UID valide. Chaje tranzaksyon pou itilizatè...");
      // detach previous listener si te genyen
      if(currentListener){
        currentListener.off();
        currentListener = null;
      }
      // Realtime listener sou users/{firebaseUid}/transactions
      const txRef = db.ref('users/' + firebaseUid + '/transactions');
      currentListener = txRef;
      txRef.on('value', (s)=>{
        clearList();
        if(!s.exists()){
          emptyEl.style.display = 'block';
          setInfo("Pa gen tranzaksyon pou UID sa a.");
          return;
        }
        emptyEl.style.display = 'none';
        const obj = s.val();
        // konvèti ak tri desandan pa timestamp / date
        const arr = Object.values(obj).sort((a,b)=>{
          const ta = a.timestamp || a.date || 0;
          const tb = b.timestamp || b.date || 0;
          return tb - ta;
        });
        arr.forEach((tx, i)=>{
          const c = document.createElement('div');
          c.className = 'card';
          const d = new Date(tx.timestamp || tx.date || Date.now());
          const prettyDate = d.toLocaleString();
          // calculate fee/res si sa pa egziste (sepandan asire pa double calc)
          let fee = (tx.fee !== undefined) ? tx.fee : (tx.minit ? (Math.round(tx.minit * 14.5)/100) : (tx.amount ? Math.round(tx.amount * 14.5)/100 : 0));
          let res = (tx.res !== undefined) ? tx.res : (tx.minit ? (tx.minit - fee) : (tx.amount ? (tx.amount - fee) : 0));
          // fomat
          fee = Number(fee).toFixed(2);
          res = Number(res).toFixed(2);
          const type = tx.type || tx.action || 'Tranzaksyon';
          const amount = tx.minit !== undefined ? tx.minit + ' minit' : (tx.amount !== undefined ? tx.amount + ' Gdes' : '-');
          const method = tx.method || '-';
          const status = tx.status || tx.state || '-';
          c.innerHTML = `
            <div class="top">
              <div class="type">${type}</div>
              <div class="date">${prettyDate}</div>
            </div>
            <p><strong>Kantite:</strong> ${amount}</p>
            <p><strong>Frè sistèm (14.5%):</strong> ${fee}</p>
            <p><strong>Rès ki rete:</strong> ${res}</p>
            <p><strong>Metòd / Remak:</strong> ${method} • ${status}</p>
          `;
          transactionsEl.appendChild(c);
        });
        setInfo("Dènye nouvo tranzaksyon chaje (" + arr.length + ").");
      }, err=>{
        showError("Erè pandan chajman: " + err.message);
      });

    }catch(err){
      showError("Erè: " + (err.message || err));
    }
  }

  // ----- button listeners -----
  loadBtn.addEventListener('click', ()=>{
    showError('');
    const v = uidInput.value.trim();
    if(!v){
      showError("Antre yon UID ARS-XXXX avan chaje.");
      return;
    }
    // sanitasyon fondamantal: li ta dwe ARS-...
    if(!/^ARS\-[A-Z0-9]{4,}$/i.test(v)){
      showError("UID sanble pa nan fòma ARS-XXXX. Egzanp: ARS-246H");
      return;
    }
    loadTransactionsForCustomUID(v);
  });

  clearBtn.addEventListener('click', ()=>{
    uidInput.value = '';
    clearList();
    emptyEl.style.display='none';
    setInfo("Antre UID oubyen itilize URL (?uid=ARS-XXXX).");
    showError('');
    if(currentListener){ currentListener.off(); currentListener=null; }
  });

  // ----- si uid te pase nan URL, chaje otomatikman -----
  if(uidFromUrl){
    // retade tip de 300ms pou UI monte
    setTimeout(()=> {
      loadTransactionsForCustomUID(uidFromUrl);
    }, 250);
  }
</script>
</body>
</html>
